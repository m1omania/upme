# Информация о генерации сопроводительных писем

## 1. Проверка работы API ИИ

### Роут зарегистрирован
- **Путь**: `POST /api/ai/generate-letter`
- **Файл**: `backend/src/routes/ai.ts`
- **Регистрация**: `backend/src/index.ts` (строка 54)

### Требования для работы
- `HUGGINGFACE_API_KEY` должен быть установлен в переменных окружения
- Модель: `Qwen/Qwen2.5-VL-7B-Instruct`
- Endpoint: `https://router.huggingface.co` (обновлен с api-inference.huggingface.co)
- Аутентификация: требуется JWT токен
- Rate limiting: `aiLimiter` (ограничение запросов)

## 2. На каком основании генерируется письмо

### Данные из вакансии:
1. **Название вакансии** (`vacancy.title`)
2. **Описание вакансии** (`vacancy.description`) - до 2000 символов
3. **Требования** (`vacancy.requirements`) - массив строк

### Данные из резюме:
1. **Должность** (`resume.title`)
2. **Опыт работы** (`resume.experience`) - до 800 символов
3. **Навыки** (`resume.skills`) - массив строк

### Источник данных:
- **Вакансия**: загружается из БД (кэш) по `vacancy_id`
- **Резюме**: загружается из БД для текущего пользователя, **автоматически выбирается резюме, которое лучше всего соответствует вакансии** (сравнивается название вакансии с названием резюме)

### Код генерации:
```typescript
// backend/src/routes/ai.ts (строки 56-63)
const letter = await aiService.generateCoverLetter(
  vacancy.title,              // Название вакансии
  vacancy.description || '',   // Описание вакансии
  vacancy.requirements || [],  // Требования
  resumeData.title,            // Должность из резюме
  resumeData.experience,       // Опыт работы
  resumeData.skills            // Навыки
);
```

## 3. Промпт для ИИ

### Полный промпт (из `backend/src/services/aiService.ts`, метод `buildPrompt`):

```
Ты профессиональный HR-специалист. Напиши убедительное сопроводительное письмо для отклика на вакансию.

ВАКАНСИЯ:
Название: {vacancyTitle}

Описание:
{vacancyDescription} (до 2000 символов)

Требования к кандидату:
{vacancyRequirements} (через запятую)

МОЕ РЕЗЮМЕ:
Должность: {resumeTitle}
Опыт работы: {resumeExperience} (до 800 символов)
Ключевые навыки: {resumeSkills} (через запятую)

ТРЕБОВАНИЯ К ПИСЬМУ:
1. Начни с профессионального приветствия
2. Кратко представься (1-2 предложения)
3. Объясни, почему ты подходишь для этой позиции:
   - Упомяни релевантный опыт из резюме
   - Подчеркни совпадение навыков с требованиями
   - Покажи заинтересованность в позиции
4. Заверши выражением готовности к обсуждению
5. Будь конкретным, но кратким (2-3 абзаца, максимум 250 слов)
6. Используй профессиональный, но дружелюбный тон
7. Избегай общих фраз, будь конкретным

Сопроводительное письмо:
```

### Параметры генерации:
- **Модель**: `Qwen/Qwen2.5-VL-7B-Instruct`
- **max_new_tokens**: 600 (увеличено для более полного письма)
- **temperature**: 0.8 (для более естественного текста)
- **top_p**: 0.95
- **repetition_penalty**: 1.2 (избегаем повторений)
- **Endpoint**: `https://router.huggingface.co` (обновлен)

### Fallback (если генерация не удалась):
```
Здравствуйте!

Меня заинтересовала вакансия "{vacancyTitle}". Я {resumeTitle} и считаю, что мой опыт и навыки соответствуют требованиям этой позиции.

Буду рад обсудить детали и рассказать, как я могу внести вклад в работу вашей команды.

С уважением
```

## 4. Кэширование

- Кэш ключ: `letter:{vacancyTitle}:{resumeTitle}`
- Время жизни: 1 час (3600 секунд)
- Если письмо уже генерировалось для этой пары вакансия+резюме, возвращается из кэша

## 5. Обработка ошибок

- Если генерация не удалась → возвращается fallback письмо
- Если ответ слишком короткий (< 150 символов) → повторная попытка с увеличенными параметрами
- Все ошибки логируются в `backend/logs/combined.log`

